<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è TCP Window Clamp | Performance Matters</title>
<meta name=keywords content="tcp,kernel,deep dive"><meta name=description content="–†–∞–∑–±–æ—Ä —Å—Ç–∞—Ç—å–∏ –æ—Ç Netflix &ldquo;Investigation of a Cross-regional Network Performance Issue&rdquo;"><meta name=author content><link rel=canonical href=https://alebedev.tech/posts/tcp-window-clamp/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.27100688bec44e71d90b7169778c0eac3af72cdb83d2fd2b79510e30556bd171.css integrity="sha256-JxAGiL7ETnHZC3Fpd4wOrDr3LNuD0v0reVEOMFVr0XE=" rel="preload stylesheet" as=style><link rel=icon href=https://alebedev.tech/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://alebedev.tech/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://alebedev.tech/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://alebedev.tech/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://alebedev.tech/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://alebedev.tech/posts/tcp-window-clamp/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-98549RKLMS"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-98549RKLMS")}</script><meta property="og:title" content="–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è TCP Window Clamp"><meta property="og:description" content="–†–∞–∑–±–æ—Ä —Å—Ç–∞—Ç—å–∏ –æ—Ç Netflix &ldquo;Investigation of a Cross-regional Network Performance Issue&rdquo;"><meta property="og:type" content="article"><meta property="og:url" content="https://alebedev.tech/posts/tcp-window-clamp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-21T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-21T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è TCP Window Clamp"><meta name=twitter:description content="–†–∞–∑–±–æ—Ä —Å—Ç–∞—Ç—å–∏ –æ—Ç Netflix &ldquo;Investigation of a Cross-regional Network Performance Issue&rdquo;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alebedev.tech/posts/"},{"@type":"ListItem","position":2,"name":"–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è TCP Window Clamp","item":"https://alebedev.tech/posts/tcp-window-clamp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è TCP Window Clamp","name":"–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è TCP Window Clamp","description":"–†–∞–∑–±–æ—Ä —Å—Ç–∞—Ç—å–∏ –æ—Ç Netflix \u0026ldquo;Investigation of a Cross-regional Network Performance Issue\u0026rdquo;","keywords":["tcp","kernel","deep dive"],"articleBody":"–†–∞–Ω–µ–µ —è —É–ø–æ–º–∏–Ω–∞–ª —Å—Ç–∞—Ç—å—é Netflix Investigation of a Cross-regional Network Performance Issue. –í –Ω–µ–π —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞–º–∏ –∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–ª–∞ –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–∞—Å—á—ë—Ç–∞ TCP Receive Window –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —è–¥—Ä–∞.\n–ö–∞–∫ —á–∞—Å—Ç–æ –±—ã–≤–∞–µ—Ç, —Ç–∞–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Å—Ç–∞–≤–ª—è—é—Ç –±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤, —á–µ–º –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî ‚Äúknow unknown‚Äù —á–∏—Å—Ç–æ–π –≤–æ–¥—ã.\n–Ø –ø–æ–∫–æ–ø–∞–ª—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö Linux, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥—Å—á–µ—Ç–∞ TCP Window. –î–µ–ª—é—Å—å –∏–∑—ã—Å–∫–∞–Ω–∏—è–º–∏:)\n–†–µ–∞–ª–∏–∑–∞—Ü–∏—è TCP/IP –≤ Linux –¥–ª—è –Ω–µ–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª—è –∫–∞–∫ —è, –º—è–≥–∫–æ –≥–æ–≤–æ—Ä—è –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω–∞. –í –Ω–µ–π –ª–µ–≥—á–µ –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è, —á–µ–º —á—Ç–æ-—Ç–æ –Ω–∞–π—Ç–∏. –ü–æ—ç—Ç–æ–º—É —è —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–ª—Å—è –Ω–∞ –æ–¥–Ω–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—â–∏: –∫–∞–∫ –∏ –≥–¥–µ –∑–∞–¥–∞—ë—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è window_clamp, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤–µ–ª–∏—á–∏–Ω—É TCP Window.\n–î–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —è–¥—Ä–æ –≤–µ—Ä—Å–∏–∏ 6.1 ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –¥–ª—è Debian 12.\n–ü–æ–µ—Ö–∞–ª–∏!\n–ß—É—Ç—å —Ç–µ–æ—Ä–∏–∏ –†–∞–∑–º–µ—Ä TCP Window –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫:\nmin(cwnd, rwnd) –≥–¥–µ:\ncwnd (congestion window) ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π (Congestion Control); rwnd (receive window) ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–º (Flow Control). –ï—Å–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å: rwnd –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –º–µ—Å—Ç–æ–º –≤ –±—É—Ñ–µ—Ä–µ —Å–æ–∫–µ—Ç–∞, –∞ cwnd —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏.\n–¶–µ–ª—å ‚Äî –≤—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä TCP Window —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ–±—ã:\n–∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ç–∏ –∏ –ø—Ä–∏—ë–º–Ω–∏–∫–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å). –æ–±–µ—Å–ø–µ—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π–¥–æ—Ñ—Ñ –º–µ–∂–¥—É –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.\n–ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –ò —Ç–∞–∫, –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç –≤ –±—É—Ñ–µ—Ä –ø—Ä–∏—ë–º–Ω–∏–∫–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π ACK —É–ª–µ—Ç–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é.\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-–ø—Ä–∏—ë–º–Ω–∏–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ —Å –ø–æ–º–æ—â—å—é —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ recvfrom(). –ù–∞ —É—Ä–æ–≤–Ω–µ —è–¥—Ä–∞ —ç—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π tcp_recvmsg(), –æ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∏ –∑–∞–¥–∞—á–∏:\n–ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é; –æ—á–∏—â–∞–µ—Ç –±—É—Ñ–µ—Ä —Å–æ–∫–µ—Ç–∞; –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –û–∫–Ω–∞ –∏, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –ø–æ–∑–≤–æ–ª—è—é—Ç, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –µ–≥–æ. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –û–∫–Ω–∞ tcp_recvmsg –≤—ã–∑—ã–≤–∞–µ—Ç tcp_cleanup_rbuf -\u003e __tcp_cleanup_rbuf, –≥–¥–µ:\n... __u32 rcv_window_now = tcp_receive_window(tp); /* Optimize, __tcp_select_window() is not cheap. */ if (2*rcv_window_now \u003c= tp-\u003ewindow_clamp) { __u32 new_window = __tcp_select_window(sk); ... –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –û–∫–Ω–∞ (rcv_window_now); –µ—Å–ª–∏ –æ–Ω –≤–¥–≤–æ–µ –º–µ–Ω—å—à–µ –∑–Ω–∞—á–µ–Ω–∏—è window_clamp, –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ –û–∫–Ω–æ —á–µ—Ä–µ–∑ __tcp_select_window. __tcp_select_window –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫, –≤–∫–ª—é—á–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫—É –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã –û–∫–Ω–∞ —á–µ—Ä–µ–∑ rcv_ssthresh:\n... if (free_space \u003e tp-\u003ercv_ssthresh) free_space = tp-\u003ercv_ssthresh; ... –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Ä–∞–∑–º–µ—Ä TCP –û–∫–Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–≤—É–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: rcv_ssthresh –∏ window_clamp.\nWindow Clamp –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä TCP-–æ–∫–Ω–∞ (window_clamp) –∑–∞–¥–∞–µ—Ç—Å—è:\n–ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–æ–∫–µ—Ç–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º –≤—ã–∑–æ–≤–æ–º setsockopt —Å –æ–ø—Ü–∏–µ–π TCP_WINDOW_CLAMP, —Å–º. man 7 tcp; –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ, —è–¥—Ä–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ä–∞–∑–º–µ—Ä–µ –±—É—Ñ–µ—Ä–∞. –Ø –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞ —Ä–∞–∑–æ–±—Ä–∞–ª –≤—Å–µ –¥–µ—Ç–∞–ª–∏, –Ω–æ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è tcp_rcv_space_adjust, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –û–Ω–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞.\n–í–Ω—É—Ç—Ä–∏ –Ω–µ–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è tcp_win_from_space:\n/* Make the window clamp follow along. */ tp-\u003ewindow_clamp = tcp_win_from_space(sk, rcvbuf); –≥–¥–µ –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Å—á–µ—Ç window_clamp —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ net.ipv4.tcp_adv_win_scale (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É —Ä–∞–≤–Ω—ã–º 1):\nstatic inline int tcp_win_from_space(const struct sock *sk, int space) { int tcp_adv_win_scale = READ_ONCE(sock_net(sk)-\u003eipv4.sysctl_tcp_adv_win_scale); return tcp_adv_win_scale \u003c= 0 ? (space\u003e\u003e(-tcp_adv_win_scale)) : space - (space\u003e\u003etcp_adv_win_scale); } –î–ª—è –ø—Ä–∏–º–µ—Ä–∞:\n–ø–∞—Ä–∞–º–µ—Ç—Ä net.ipv4.tcp_adv_win_scale=1; —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏—ë–º–∞ (rcvbuf) ‚Äî 64 –ö–ë. –¢–æ–≥–¥–∞ —Ñ–æ—Ä–º—É–ª–∞ –ø—Ä–∏–º–µ—Ç –≤–∏–¥:\n(space \u003e\u003e 1) = 64 –ö–ë / 2 = 32 –ö–ë –í—ã–≤–æ–¥—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ window_clamp –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏—ë–º–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ net.ipv4.tcp_rmem –∏ net.core.rmem_max; –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ window_clamp —Å–≤—è–∑–∞–Ω–æ —Å net.ipv4.tcp_adv_win_scale –∏ rcvbuf. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–Ω–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 50%. –í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —è–¥—Ä–∞ –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å—á—ë—Ç–∞ window_clamp –∏–∑–º–µ–Ω–∏–ª—Å—è:\nstatic inline int __tcp_win_from_space(u8 scaling_ratio, int space) { s64 scaled_space = (s64)space * scaling_ratio; return scaled_space \u003e\u003e TCP_RMEM_TO_WIN_SCALE; } –ö–ª—é—á–µ–≤—É—é —Ä–æ–ª—å –∑–¥–µ—Å—å –∏–≥—Ä–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è scaling_ratio, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–ø—Ä—è–º—É—é –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è TCP_DEFAULT_SCALING_RATIO:\n#define TCP_DEFAULT_SCALING_RATIO (1 \u003c\u003c (TCP_RMEM_TO_WIN_SCALE - 1)) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è scaling_ratio –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ tcp_scaling_ratio_init:\nstatic inline void tcp_scaling_ratio_init(struct sock *sk) { tcp_sk(sk)-\u003escaling_ratio = TCP_DEFAULT_SCALING_RATIO; } –î–æ —Ñ–∏–∫—Å–∞ –æ—Ç Netflix, TCP_DEFAULT_SCALING_RATIO –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ 25%. –ß—Ç–æ –∏ –ø—Ä–∏–≤–µ–ª–æ –∫ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞ —Å—á–µ—Ç –¥–≤—É–∫—Ä–∞—Ç–Ω–æ–≥–æ —Å–Ω–∏–∂–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ TCP Window.\n–¢–µ–ø–µ—Ä—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ–Ω—è—Ç–Ω–µ–µ üòâ\n","wordCount":"572","inLanguage":"en","datePublished":"2024-11-21T00:00:00Z","dateModified":"2024-11-21T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alebedev.tech/posts/tcp-window-clamp/"},"publisher":{"@type":"Organization","name":"Performance Matters","logo":{"@type":"ImageObject","url":"https://alebedev.tech/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://alebedev.tech/ accesskey=h title="Performance matters! (Alt + H)"><img src=https://alebedev.tech/images/favicon.ico alt aria-label=logo height=35>Performance matters!</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://alebedev.tech/about/ title=About><span>About</span></a></li><li><a href=https://alebedev.tech/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://alebedev.tech/for_hr/ title="For HR"><span>For HR</span></a></li><li><a href=https://alebedev.tech/mentoring/ title=Mentoring><span>Mentoring</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://alebedev.tech/>Home</a>&nbsp;¬ª&nbsp;<a href=https://alebedev.tech/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è TCP Window Clamp</h1><div class=post-meta><span title='2024-11-21 00:00:00 +0000 UTC'>November 21, 2024</span>&nbsp;¬∑&nbsp;3 min</div></header><div class=post-content><p><a href=https://t.me/troubleperf/52>–†–∞–Ω–µ–µ —è —É–ø–æ–º–∏–Ω–∞–ª</a> —Å—Ç–∞—Ç—å—é Netflix <a href=https://netflixtechblog.com/investigation-of-a-cross-regional-network-performance-issue-422d6218fdf1><strong>Investigation of a Cross-regional Network Performance Issue</strong></a>. –í –Ω–µ–π —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞–º–∏ –∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–ª–∞ –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–∞—Å—á—ë—Ç–∞ TCP Receive Window –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —è–¥—Ä–∞.</p><p>–ö–∞–∫ —á–∞—Å—Ç–æ –±—ã–≤–∞–µ—Ç, —Ç–∞–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Å—Ç–∞–≤–ª—è—é—Ç –±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤, —á–µ–º –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî &ldquo;know unknown&rdquo; —á–∏—Å—Ç–æ–π –≤–æ–¥—ã.</p><p>–Ø –ø–æ–∫–æ–ø–∞–ª—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö Linux, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥—Å—á–µ—Ç–∞ TCP Window.
–î–µ–ª—é—Å—å –∏–∑—ã—Å–∫–∞–Ω–∏—è–º–∏:)</p><blockquote><p>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è TCP/IP –≤ Linux –¥–ª—è –Ω–µ–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª—è –∫–∞–∫ —è, –º—è–≥–∫–æ –≥–æ–≤–æ—Ä—è –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω–∞. –í –Ω–µ–π –ª–µ–≥—á–µ –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è, —á–µ–º —á—Ç–æ-—Ç–æ –Ω–∞–π—Ç–∏. –ü–æ—ç—Ç–æ–º—É —è —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–ª—Å—è –Ω–∞ –æ–¥–Ω–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—â–∏: –∫–∞–∫ –∏ –≥–¥–µ –∑–∞–¥–∞—ë—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è <code>window_clamp</code>, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤–µ–ª–∏—á–∏–Ω—É TCP Window.</p></blockquote><blockquote><p>–î–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —è–¥—Ä–æ –≤–µ—Ä—Å–∏–∏ 6.1 ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –¥–ª—è Debian 12.</p></blockquote><p>–ü–æ–µ—Ö–∞–ª–∏!</p><hr><h3 id=—á—É—Ç—å-—Ç–µ–æ—Ä–∏–∏>–ß—É—Ç—å —Ç–µ–æ—Ä–∏–∏<a hidden class=anchor aria-hidden=true href=#—á—É—Ç—å-—Ç–µ–æ—Ä–∏–∏>#</a></h3><p>–†–∞–∑–º–µ—Ä TCP Window –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>min<span class=o>(</span>cwnd, rwnd<span class=o>)</span>  
</span></span></code></pre></div><p>–≥–¥–µ:</p><ul><li><code>cwnd</code> (congestion window) ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π (Congestion Control);</li><li><code>rwnd</code> (receive window) ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–º (Flow Control).</li></ul><p>–ï—Å–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å: <code>rwnd</code> –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –º–µ—Å—Ç–æ–º –≤ –±—É—Ñ–µ—Ä–µ —Å–æ–∫–µ—Ç–∞, –∞ <code>cwnd</code> —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏.</p><p>–¶–µ–ª—å ‚Äî –≤—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä TCP Window —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ–±—ã:</p><ol><li>–∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ç–∏ –∏ –ø—Ä–∏—ë–º–Ω–∏–∫–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å).</li><li>–æ–±–µ—Å–ø–µ—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö.</li></ol><p>–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π–¥–æ—Ñ—Ñ –º–µ–∂–¥—É –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.</p><h3 id=–ø–æ–≥—Ä—É–∂–∞–µ–º—Å—è>–ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è<a hidden class=anchor aria-hidden=true href=#–ø–æ–≥—Ä—É–∂–∞–µ–º—Å—è>#</a></h3><p>–ò —Ç–∞–∫, –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç –≤ –±—É—Ñ–µ—Ä –ø—Ä–∏—ë–º–Ω–∏–∫–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π <code>ACK</code> —É–ª–µ—Ç–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é.</p><p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-–ø—Ä–∏—ë–º–Ω–∏–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ —Å –ø–æ–º–æ—â—å—é —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ <a href=https://linux.die.net/man/2/recvfrom>recvfrom()</a>. –ù–∞ —É—Ä–æ–≤–Ω–µ —è–¥—Ä–∞ —ç—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π <a href=https://elixir.bootlin.com/linux/v6.1.90/source/net/ipv4/tcp.c#L2685>tcp_recvmsg()</a>, –æ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∏ –∑–∞–¥–∞—á–∏:</p><ul><li>–ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é;</li><li>–æ—á–∏—â–∞–µ—Ç –±—É—Ñ–µ—Ä —Å–æ–∫–µ—Ç–∞;</li><li>–æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –û–∫–Ω–∞ –∏, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –ø–æ–∑–≤–æ–ª—è—é—Ç, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –µ–≥–æ.</li></ul><p>–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –û–∫–Ω–∞ <code>tcp_recvmsg</code> –≤—ã–∑—ã–≤–∞–µ—Ç <a href=https://elixir.bootlin.com/linux/v6.1.90/source/net/ipv4/tcp.c#L1592><code>tcp_cleanup_rbuf</code> -> <code>__tcp_cleanup_rbuf</code></a>, –≥–¥–µ:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>		<span class=n>__u32</span> <span class=n>rcv_window_now</span> <span class=o>=</span> <span class=nf>tcp_receive_window</span><span class=p>(</span><span class=n>tp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=cm>/* Optimize, __tcp_select_window() is not cheap. */</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=n>rcv_window_now</span> <span class=o>&lt;=</span> <span class=n>tp</span><span class=o>-&gt;</span><span class=n>window_clamp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>__u32</span> <span class=n>new_window</span> <span class=o>=</span> <span class=nf>__tcp_select_window</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><ul><li>–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –û–∫–Ω–∞ (<code>rcv_window_now</code>);</li><li>–µ—Å–ª–∏ –æ–Ω –≤–¥–≤–æ–µ –º–µ–Ω—å—à–µ –∑–Ω–∞—á–µ–Ω–∏—è <code>window_clamp</code>,</li><li>–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ –û–∫–Ω–æ —á–µ—Ä–µ–∑ <a href=https://elixir.bootlin.com/linux/v6.1.90/source/net/ipv4/tcp_output.c#L2963><code>__tcp_select_window</code></a>.</li></ul><p><code>__tcp_select_window</code> –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫, –≤–∫–ª—é—á–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫—É –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã –û–∫–Ω–∞ —á–µ—Ä–µ–∑ <code>rcv_ssthresh</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>free_space</span> <span class=o>&gt;</span> <span class=n>tp</span><span class=o>-&gt;</span><span class=n>rcv_ssthresh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>free_space</span> <span class=o>=</span> <span class=n>tp</span><span class=o>-&gt;</span><span class=n>rcv_ssthresh</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><p>–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Ä–∞–∑–º–µ—Ä TCP –û–∫–Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–≤—É–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: <code>rcv_ssthresh</code> –∏ <code>window_clamp</code>.</p><h3 id=window-clamp>Window Clamp<a hidden class=anchor aria-hidden=true href=#window-clamp>#</a></h3><p>–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä TCP-–æ–∫–Ω–∞ (<code>window_clamp</code>) –∑–∞–¥–∞–µ—Ç—Å—è:</p><ul><li>–ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–æ–∫–µ—Ç–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º –≤—ã–∑–æ–≤–æ–º <code>setsockopt</code> —Å –æ–ø—Ü–∏–µ–π <code>TCP_WINDOW_CLAMP</code>, —Å–º. <a href=https://man7.org/linux/man-pages/man7/tcp.7.html>man 7 tcp</a>;</li><li>–µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ, —è–¥—Ä–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ä–∞–∑–º–µ—Ä–µ –±—É—Ñ–µ—Ä–∞.</li></ul><p>–Ø –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞ —Ä–∞–∑–æ–±—Ä–∞–ª –≤—Å–µ –¥–µ—Ç–∞–ª–∏, –Ω–æ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è <a href=https://elixir.bootlin.com/linux/v6.1.90/source/net/ipv4/tcp_input.c#L713><code>tcp_rcv_space_adjust</code></a>, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –û–Ω–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞.</p><p>–í–Ω—É—Ç—Ä–∏ –Ω–µ–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è <a href=https://elixir.bootlin.com/linux/v6.1.90/source/include/net/tcp.h#L1442><code>tcp_win_from_space</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>			<span class=cm>/* Make the window clamp follow along.  */</span>
</span></span><span class=line><span class=cl>			<span class=n>tp</span><span class=o>-&gt;</span><span class=n>window_clamp</span> <span class=o>=</span> <span class=nf>tcp_win_from_space</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>rcvbuf</span><span class=p>);</span>
</span></span></code></pre></div><p>–≥–¥–µ –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Å—á–µ—Ç <code>window_clamp</code> —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ <code>net.ipv4.tcp_adv_win_scale</code> (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É —Ä–∞–≤–Ω—ã–º 1):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>int</span> <span class=nf>tcp_win_from_space</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk</span><span class=p>,</span> <span class=kt>int</span> <span class=n>space</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>tcp_adv_win_scale</span> <span class=o>=</span> <span class=nf>READ_ONCE</span><span class=p>(</span><span class=nf>sock_net</span><span class=p>(</span><span class=n>sk</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>ipv4</span><span class=p>.</span><span class=n>sysctl_tcp_adv_win_scale</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>tcp_adv_win_scale</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>		<span class=p>(</span><span class=n>space</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=o>-</span><span class=n>tcp_adv_win_scale</span><span class=p>))</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=n>space</span> <span class=o>-</span> <span class=p>(</span><span class=n>space</span><span class=o>&gt;&gt;</span><span class=n>tcp_adv_win_scale</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>–î–ª—è –ø—Ä–∏–º–µ—Ä–∞:</p><ul><li>–ø–∞—Ä–∞–º–µ—Ç—Ä <code>net.ipv4.tcp_adv_win_scale=1</code>;</li><li>—Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏—ë–º–∞ (<code>rcvbuf</code>) ‚Äî 64 –ö–ë.</li></ul><p>–¢–æ–≥–¥–∞ —Ñ–æ—Ä–º—É–ª–∞ –ø—Ä–∏–º–µ—Ç –≤–∏–¥:</p><pre tabindex=0><code>(space &gt;&gt; 1) = 64 –ö–ë / 2 = 32 –ö–ë
</code></pre><h3 id=–≤—ã–≤–æ–¥—ã>–í—ã–≤–æ–¥—ã<a hidden class=anchor aria-hidden=true href=#–≤—ã–≤–æ–¥—ã>#</a></h3><ol><li>–∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ <code>window_clamp</code> –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏—ë–º–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ <code>net.ipv4.tcp_rmem</code> –∏ <code>net.core.rmem_max</code>;</li><li>–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ <code>window_clamp</code> —Å–≤—è–∑–∞–Ω–æ —Å <code>net.ipv4.tcp_adv_win_scale</code> –∏ <code>rcvbuf</code>. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–Ω–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 50%.</li></ol><p>–í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —è–¥—Ä–∞ <a href=https://elixir.bootlin.com/linux/v6.8.10/source/include/net/tcp.h#L1471>–º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å—á—ë—Ç–∞ window_clamp</a> –∏–∑–º–µ–Ω–∏–ª—Å—è:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>int</span> <span class=nf>__tcp_win_from_space</span><span class=p>(</span><span class=n>u8</span> <span class=n>scaling_ratio</span><span class=p>,</span> <span class=kt>int</span> <span class=n>space</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>s64</span> <span class=n>scaled_space</span> <span class=o>=</span> <span class=p>(</span><span class=n>s64</span><span class=p>)</span><span class=n>space</span> <span class=o>*</span> <span class=n>scaling_ratio</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>scaled_space</span> <span class=o>&gt;&gt;</span> <span class=n>TCP_RMEM_TO_WIN_SCALE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>–ö–ª—é—á–µ–≤—É—é —Ä–æ–ª—å –∑–¥–µ—Å—å –∏–≥—Ä–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è <a href=https://elixir.bootlin.com/linux/v6.8.10/source/include/linux/tcp.h#L224><code>scaling_ratio</code></a>, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–ø—Ä—è–º—É—é –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è <a href=https://elixir.bootlin.com/linux/v6.8.10/source/include/net/tcp.h#L1500><code>TCP_DEFAULT_SCALING_RATIO</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=err>#</span><span class=n>define</span><span class=w> </span><span class=nf>TCP_DEFAULT_SCALING_RATIO</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=p>(</span><span class=n>TCP_RMEM_TO_WIN_SCALE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></div><p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è <code>scaling_ratio</code> –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ <a href=https://elixir.bootlin.com/linux/v6.8.10/source/include/net/tcp.h#L1503><code>tcp_scaling_ratio_init</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>tcp_scaling_ratio_init</span><span class=p>(</span><span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>tcp_sk</span><span class=p>(</span><span class=n>sk</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>scaling_ratio</span> <span class=o>=</span> <span class=n>TCP_DEFAULT_SCALING_RATIO</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>–î–æ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=697a6c8cec03">—Ñ–∏–∫—Å–∞ –æ—Ç Netflix</a>, <code>TCP_DEFAULT_SCALING_RATIO</code> –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ 25%. –ß—Ç–æ –∏ –ø—Ä–∏–≤–µ–ª–æ –∫ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞ —Å—á–µ—Ç –¥–≤—É–∫—Ä–∞—Ç–Ω–æ–≥–æ —Å–Ω–∏–∂–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ TCP Window.</p><p>–¢–µ–ø–µ—Ä—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ–Ω—è—Ç–Ω–µ–µ üòâ</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://alebedev.tech/tags/tcp/>Tcp</a></li><li><a href=https://alebedev.tech/tags/kernel/>Kernel</a></li><li><a href=https://alebedev.tech/tags/deep-dive/>Deep Dive</a></li></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-alebsys-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://alebedev.tech/>Performance Matters</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>