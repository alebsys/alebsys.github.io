<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Haproxy memory leak | Performance Matters</title>
<meta name=keywords content="linux,haproxy,memory,network,troubleshooting"><meta name=description content="–ù–∞ –¥–Ω—è—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ haproxy, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –±–æ–ª–µ–µ –¥–æ–ª–≥–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã.
–ù–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ —Ö–æ—á—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–µ—Ç—Ä–æ.
–ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ–∏—Å–∫–æ–º –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º, –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º, –±—É–¥—å —Ç–æ runtime –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–µ—Ç—å, —Å–ª–æ–π –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —á—Ç–æ-—É–≥–æ–¥–Ω–æ –µ—â–µ.
–í —ç—Ç–æ—Ç —Ä–∞–∑ –ø–æ OOM –ø—Ä–∏–±–∏–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ haproxy - —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ. –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ."><meta name=author content><link rel=canonical href=https://alebsys.github.io/posts/haproxy-mem-leak/><meta name=google-site-verification content="8480017300"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.27100688bec44e71d90b7169778c0eac3af72cdb83d2fd2b79510e30556bd171.css integrity="sha256-JxAGiL7ETnHZC3Fpd4wOrDr3LNuD0v0reVEOMFVr0XE=" rel="preload stylesheet" as=style><link rel=icon href=https://alebsys.github.io/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://alebsys.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://alebsys.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://alebsys.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://alebsys.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://alebsys.github.io/posts/haproxy-mem-leak/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-98549RKLMS"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-98549RKLMS")}</script><meta property="og:title" content="Haproxy memory leak"><meta property="og:description" content="–ù–∞ –¥–Ω—è—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ haproxy, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –±–æ–ª–µ–µ –¥–æ–ª–≥–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã.
–ù–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ —Ö–æ—á—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–µ—Ç—Ä–æ.
–ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ–∏—Å–∫–æ–º –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º, –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º, –±—É–¥—å —Ç–æ runtime –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–µ—Ç—å, —Å–ª–æ–π –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —á—Ç–æ-—É–≥–æ–¥–Ω–æ –µ—â–µ.
–í —ç—Ç–æ—Ç —Ä–∞–∑ –ø–æ OOM –ø—Ä–∏–±–∏–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ haproxy - —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ. –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ."><meta property="og:type" content="article"><meta property="og:url" content="https://alebsys.github.io/posts/haproxy-mem-leak/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-31T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-31T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Haproxy memory leak"><meta name=twitter:description content="–ù–∞ –¥–Ω—è—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ haproxy, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –±–æ–ª–µ–µ –¥–æ–ª–≥–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã.
–ù–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ —Ö–æ—á—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–µ—Ç—Ä–æ.
–ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ–∏—Å–∫–æ–º –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º, –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º, –±—É–¥—å —Ç–æ runtime –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–µ—Ç—å, —Å–ª–æ–π –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —á—Ç–æ-—É–≥–æ–¥–Ω–æ –µ—â–µ.
–í —ç—Ç–æ—Ç —Ä–∞–∑ –ø–æ OOM –ø—Ä–∏–±–∏–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ haproxy - —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ. –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alebsys.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Haproxy memory leak","item":"https://alebsys.github.io/posts/haproxy-mem-leak/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Haproxy memory leak","name":"Haproxy memory leak","description":"–ù–∞ –¥–Ω—è—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ haproxy, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –±–æ–ª–µ–µ –¥–æ–ª–≥–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã.\n–ù–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ —Ö–æ—á—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–µ—Ç—Ä–æ.\n–ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ–∏—Å–∫–æ–º –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º, –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º, –±—É–¥—å —Ç–æ runtime –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–µ—Ç—å, —Å–ª–æ–π –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —á—Ç–æ-—É–≥–æ–¥–Ω–æ –µ—â–µ.\n–í —ç—Ç–æ—Ç —Ä–∞–∑ –ø–æ OOM –ø—Ä–∏–±–∏–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ haproxy - —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ. –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ.","keywords":["linux","haproxy","memory","network","troubleshooting"],"articleBody":"–ù–∞ –¥–Ω—è—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ haproxy, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –±–æ–ª–µ–µ –¥–æ–ª–≥–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã.\n–ù–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ —Ö–æ—á—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–µ—Ç—Ä–æ.\n–ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ–∏—Å–∫–æ–º –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º, –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º, –±—É–¥—å —Ç–æ runtime –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–µ—Ç—å, —Å–ª–æ–π –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —á—Ç–æ-—É–≥–æ–¥–Ω–æ –µ—â–µ.\n–í —ç—Ç–æ—Ç —Ä–∞–∑ –ø–æ OOM –ø—Ä–∏–±–∏–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ haproxy - —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ. –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ.\n–°–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ node_exporter –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞–Ω–æ–º–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ (RAM Used), —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∏ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–∫–∞—á–∫–∞–º–∏:\n–õ–æ–≥ OOM —Å–æ–±—ã—Ç–∏—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —É—Ç–µ–∫–ª–∏ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å—ã haproxy (–≤—ã–≤–æ–¥ –ø–æ—Ä–µ–∑–∞–Ω):\n$ dmesg -T | grep oom ... Tasks state (memory values in pages): [ pid ] rss name ... [2887591] 1124 haproxy [2887593] 83058 haproxy [2931744] 226614 haproxy [3093691] 37094 haproxy [3165698] 33991 haproxy [3180514] 52974 haproxy [3192011] 127215 haproxy [3246961] 150239 haproxy [3280907] 209137 haproxy [3310000] 199742 haproxy [3387199] 21094 haproxy [3387315] 77567 haproxy [3408004] 226766 haproxy [3776117] 230883 haproxy [ 170279] 142573 haproxy [ 218073] 265815 haproxy [ 402741] 183463 haproxy [ 509821] 76463 haproxy [ 515738] 194395 haproxy [ 586958] 27402 haproxy [ 599282] 100527 haproxy [ 636940] 231200 haproxy [ 912356] 170641 haproxy [1270565] 168217 haproxy [1664780] 54852 haproxy [1677084] 27638 haproxy [1751081] 228705 haproxy ... Out of memory: Killed process 218073 (haproxy) total-vm:1347736kB, anon-rss:1058308kB, file-rss:108kB, shmem-rss:4844kB, UID:110 pgtables:2244kB oom_score_adj: ... –∑–Ω–∞—á–µ–Ω–∏—è rss –∫–æ–ª–æ–Ω–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏, –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–≤–Ω–∞ 4096 –±–∞–π—Ç.\n–í –ª–æ–≥–∞—Ö haproxy –∏ –µ–≥–æ systemd —é–Ω–∏—Ç–∞ –Ω–µ –±—ã–ª–æ –Ω–∏—á–µ–≥–æ –Ω–µ–æ–±—ã—á–Ω–æ–≥–æ, —Ç–æ–ª—å–∫–æ —Ä–µ—Å—Ç–∞—Ä—Ç—ã –æ—Ç –∫–æ–ª–ª–µ–≥ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–æ–º.\n–Ø —Å—Ç–∞–ª –ø–æ–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∞–ª–µ–µ –∏ —É–≤–∏–¥–µ–ª –∑–∞–Ω—è—Ç–Ω—É—é –ª–µ—Å–µ–Ω–∫—É –≤ –æ–±—ä–µ–º–µ –ø–∞–º—è—Ç–∏ –ø–æ–¥ TCP —Å–æ–∫–µ—Ç—ã:\n—ç—Ç–æ –æ–±—â–µ—Å–∏—Å—Ç–µ–º–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –∏ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –µ–π –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å, —Ç–∞–∫ –∫–∞–∫ haproxy –∂–∏–≤–µ—Ç –≤ —Ö–æ—Å—Ç–æ–≤–æ–º network namespace.\n–õ–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –º–∞—à–∏–Ω–µ –±—ã–ª–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ established TCP-–∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ –≤ –ø—Ä–∏–µ–º–Ω—ã—Ö –±—É—Ñ–µ—Ä–∞—Ö:\n$ ss -nta state established -mO | awk '{ if ( $1 \u003e 0 ) print }' Recv-Q Send-Q Local Address:Port Peer Address:Port Process 299846 0 10.10.24.5:59390 10.10.8.124:80 skmem:(r407424,rb425984,t0,tb425984,f2176,w0,o0,bl0,d12) 293893 0 10.10.24.5:60060 10.10.8.123:80 skmem:(r399552,rb425984,t0,tb425984,f1856,w0,o0,bl0,d10) 296359 0 10.10.24.5:49260 10.10.8.125:80 skmem:(r406144,rb425984,t0,tb425984,f3456,w0,o0,bl0,d15) 303378 0 10.10.24.5:33750 10.10.8.123:80 skmem:(r417024,rb425984,t0,tb425984,f768,w0,o0,bl0,d10) 299837 0 10.10.24.5:59202 10.10.8.125:80 skmem:(r413568,rb425984,t0,tb425984,f128,w0,o0,bl0,d12) 303536 0 10.10.24.5:37230 10.10.8.124:80 skmem:(r417536,rb425984,t0,tb425984,f256,w0,o0,bl0,d13) 303492 0 10.10.24.5:45944 10.10.8.125:80 skmem:(r415360,rb425984,t0,tb425984,f2432,w0,o0,bl0,d16) ... Recv-Q - —Å–∫–æ–ª—å–∫–æ –±–∞–π—Ç –¥–∞–Ω–Ω—ã—Ö –æ–∂–∏–¥–∞–µ—Ç —á—Ç–µ–Ω–∏—è, –∞ skmem_r - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–æ –ø–∞–º—è—Ç–∏ –ø–æ–¥ —Å–æ–∫–µ—Ç (Recv-Q + metadata), –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ —ç—Ç–æ —Ç—É—Ç.\n–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ –ø–æ–¥–æ–±–Ω—ã–µ –∫–æ–Ω–Ω–µ–∫—Ç—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–µ, –≤ –∞–ø—Å—Ç—Ä–∏–º–∞—Ö –∏—Ö –Ω–µ –±—ã–ª–æ.\n–§–ª–∞–≥ -i –¥–∞—Å—Ç —á—É—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ (–≤—ã–≤–æ–¥ —Å–æ–∫—Ä–∞—â–µ–Ω):\n$ ss -nta state established -Oi | grep -A 1 59390 299846 0 10.10.24.5:59390 10.10.8.124:80 ...cubic...lastsnd:369593792 lastrcv:369592940 lastack:369592940 –ü–æ–ª—è last* –≥–æ–≤–æ—Ä—è—Ç, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ç–∞–≥–Ω–∏—Ä—É–µ—Ç –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 369592940 ms, —á—Ç–æ —Ä–∞–≤–Ω–æ –±–æ–ª–µ–µ 100 —á–∞—Å–∞–º.\n–ó–Ω–∞—á–µ–Ω–∏—è last* –∫–∞–∂–¥–æ–≥–æ ‚Äú–∑–∞–≤–∏—Å—à–µ–≥–æ‚Äù —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–∞–ª–æ—Å—å, –Ω–æ –≤ —Ü–µ–ª–æ–º –æ–Ω–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º. –Ø –æ—Ç–º–µ—Ç–∏–ª —ç—Ç–æ, –Ω–æ –≤ —Ü–µ–ª–æ–º –ø—Ä–æ—à–µ–ª –¥–∞–ª—å—à–µ (–∞ –∑—Ä—è!).\n–í —Ç–æ–∂–µ –≤—Ä–µ–º—è —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ TCP —Å–æ–∫–µ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Ä–∞—Å—Ç–∏:\n–ö–∞–∂–µ—Ç—Å—è —è –Ω–∞–ø–∞–ª –Ω–∞ —Å–ª–µ–¥!\nhaproxy –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –∫–æ–Ω–Ω–µ–∫—Ç—ã –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–µ —Ö–æ—á–µ—Ç (–Ω–µ –º–æ–∂–µ—Ç?) –≤—ã—á–∏—Ç–∞—Ç—å –∏—Ö. –Ø —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª –≥–∏–ø–æ—Ç–µ–∑—É - –ø–∞–º—è—Ç—å —Ä–∞—Å—Ö–æ–¥—É–µ—Ç—Å—è –∑–∞ —Å—á–µ—Ç ‚Äú–ø–æ–≤–∏—Å—à–∏—Ö‚Äù –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤.\nüí° –î–∞-–¥–∞, —Ç—É—Ç —Å–∫–æ—Ä–µ–µ –Ω–∞—Ç—è–≥–∏–≤–∞–Ω–∏–µ —Å–æ–≤—ã –Ω–∞ –≥–ª–æ–±—É—Å, —Ç–∞–∫ –∫–∞–∫ –ø–æ–¥ –∫–æ–Ω–Ω–µ–∫—Ç—ã –≤ –ø–∏–∫–µ –±—ã–ª–æ –≤—ã–¥–µ–ª–µ–Ω–æ ~240MB, —á—Ç–æ –∫–æ–Ω–µ—á–Ω–æ –Ω–µ —É–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –æ–±—â–∏–º–∏ –ø–æ—Ç–µ—Ä—è–º–∏. –ù–æ —á—Ç–æ –µ—Å–ª–∏ haproxy –ø–æ–¥ —ç—Ç–∏ –∫–æ–Ω–Ω–µ–∫—Ç—ã —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ –ø–∞–º—è—Ç–∏?\n–í –æ–±—â–µ–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –æ—á–µ–≤–∏–¥–Ω–∞ –∏ —è –Ω–∞—á–∞–ª —Ä–∞—Å–∫—Ä—É—á–∏–≤–∞—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é.\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑ TCP keepalive –º–µ—Ö–∞–Ω–∏–∑–º—ã –º–æ–≥–ª–∏ –±—ã –ø–æ–º–æ—á—å –≤ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤, –Ω–æ –æ–Ω–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±—É—Ñ–µ—Ä–∞—Ö (–ø—Ä–æ–≤–µ—Ä—è–ª –ø–æ–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–Ω—è—Ç–∏–µ –¥–∞–º–ø–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –¥–≤–∏–∂–µ–Ω–∏–π –ø–∞–∫–µ—Ç–æ–≤ –≤ —Å–æ–∫–µ—Ç–µ –∑–∞–º–µ—á–µ–Ω–æ –Ω–µ –±—ã–ª–æ).\n–ù–æ –ø–æ—á–µ–º—É —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∫—Ç–æ –Ω–µ —á–∏—Ç–∞–µ—Ç? –ü—Ä–æ—Ü–µ—Å—Å—ã (–≤–ª–∞–¥–µ–ª—å—Ü—ã —Å–æ–∫–µ—Ç–æ–≤) –≤—ã–≥–ª—è–¥—è—Ç –≤–ø–æ–ª–Ω–µ –∂–∏–≤—ã–º–∏.\n–ü–æ—Å–ª–µ –±–µ–≥–ª–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —è –Ω–µ —Å–º–æ–≥ –¥–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏—á–Ω–µ–µ —á–µ–º ‚Äú–ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–∏—Å–ª–∏ –∏/–∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã‚Äù.\n–ò–∑ –±—ã—Å—Ç—Ä—ã—Ö work-around‚Äô–æ–≤ –≤ –≥–æ–ª–æ–≤—É –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ –ª–∏–±–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç haproxy –ª–∏–±–æ –æ—Ç—Å—Ç—Ä–µ–ª–∏–≤–∞–Ω–∏–µ –ø–æ–≤–∏—Å—à–∏—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤.\n–ò —Ç—É—Ç –Ω–∞ –≥–ª–∞–∑–∞ –º–Ω–µ –ø–æ–ø–∞–ª—Å—è –≥—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ UDP –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ (UDP_inuse):\n–ö–∞–∂–¥—ã–π —Å–∫–∞—á–µ–∫ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Ö–æ—Ä–æ—à–æ –±—ã–ª –≤–∏–¥–µ–Ω –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –æ—Ç–ª–∏—á–∏–∏ –æ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è TCP.\n–Ø —Å–æ–ø–æ—Å—Ç–∞–≤–∏–ª —ç—Ç–∏ —Ç–∞–π–º–∏–Ω–≥–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ atop - –≤ –º–æ–º–µ–Ω—Ç —Ä–æ—Å—Ç–∞ UDP –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–ª—Å—è –µ—â–µ –æ–¥–Ω–∏ –ø—Ä–æ—Ü–µ—Å—Å haproxy, —Ç–æ–≥–¥–∞ –∫–∞–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å.\n–ò –µ—â–µ —Ä–∞–∑ –ø—Ä–∏—Å–º–æ—Ç—Ä–µ–ª—Å—è –∫ systemd –ª–æ–≥–∞–º:\n$ journalctl -u haproxy ... Jan 23 08:58:25 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 23 08:58:25 haproxy[2887591]: [NOTICE] (2887591) : New worker (2931744) forked Jan 25 04:42:44 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 25 04:42:44 haproxy[2887591]: [NOTICE] (2887591) : New worker (3093691) forked Jan 25 06:40:45 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 25 06:40:45 haproxy[2887591]: [NOTICE] (2887591) : New worker (3144234) forked Jan 25 07:06:58 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 25 07:06:58 haproxy[2887591]: [NOTICE] (2887591) : New worker (3157985) forked Jan 25 07:10:56 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 25 07:10:56 haproxy[2887591]: [NOTICE] (2887591) : New worker (3159942) forked Jan 25 07:42:50 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 25 07:42:50 haproxy[2887591]: [NOTICE] (2887591) : New worker (3165698) forked Jan 26 11:11:56 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 26 11:11:56 haproxy[2887591]: [NOTICE] (2887591) : New worker (3387315) forked Jan 26 11:41:37 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 26 11:41:37 haproxy[2887591]: [NOTICE] (2887591) : New worker (3408004) forked Jan 30 08:45:37 haproxy[2887591]: Reloaded HAPEE Load Balancer. Jan 30 08:45:37 haproxy[2887591]: [NOTICE] (2887591) : New worker (3776117) forked Feb 5 03:58:20 haproxy[2887591]: Reloaded HAPEE Load Balancer. Feb 5 03:58:20 haproxy[2887591]: [NOTICE] (2887591) : New worker (148797) forked Feb 5 03:59:15 haproxy[2887591]: Reloaded HAPEE Load Balancer. Feb 5 03:59:15 haproxy[2887591]: [NOTICE] (2887591) : New worker (149187) forked Feb 5 04:29:50 haproxy[2887591]: Reloaded HAPEE Load Balancer. Feb 5 04:29:50 haproxy[2887591]: [NOTICE] (2887591) : New worker (164172) forked Feb 5 04:47:53 haproxy[2887591]: Reloaded HAPEE Load Balancer. Feb 5 04:47:53 haproxy[2887591]: [NOTICE] (2887591) : New worker (170279) forked Feb 5 14:17:46 haproxy[2887591]: Reloaded HAPEE Load Balancer. Feb 5 14:17:46 haproxy[2887591]: [NOTICE] (2887591) : New worker (218073) forked ... –ü–∞–∑–ª —Å—Ç–∞–ª —Å–æ–±–∏—Ä–∞—Ç—å—Å—è.\n–†–µ—Å—Ç–∞—Ä—Ç haproxy –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –ø–æ—Ä–æ–∂–¥–µ–Ω–∏—é –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –∞–∫—Ç–∏–≤–Ω–æ –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞–ª –ø–∞–º—è—Ç—å –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã (–Ω–∞–ø–æ–º–Ω—é —á—Ç–æ —Å—Ç–∞—Ä—ã–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å). –°–ª–µ–¥—É—é—â–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç –¥–æ–±–∞–≤–ª—è–ª –µ—â–µ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å –∏ —Ç–∞–∫ –ø–æ –∫—Ä—É–≥—É, –ø–æ–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä–µ–º –ø–∞–º—è—Ç–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª OOM Killer.\n–Ø –Ω–∞–∫–æ–Ω–µ—Ü –¥–æ–±—Ä–∞–ª—Å—è –¥–æ –∫–æ–Ω—Ñ–∏–≥–∞ haproxy, —á—Ç–æ –¥–∞–ª–æ –º–Ω–µ –µ—â–µ –æ–¥–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–ª–∏—á–∏—è —É—Ç–µ—á–∫–∏ - –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –¥–∏—Ä–µ–∫—Ç–∏–≤–æ–π nbthread 6, —Ç–æ –µ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ç—Ä–µ–¥—ã –æ–¥–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞. –ê —É –Ω–∞—Å –≤–æ—Ä–∫–µ—Ä–æ–≤ –±—ã–ª–∏ –¥–µ—Å—è—Ç–∫–∏.\n–ù–∞–∫–æ–Ω–µ—Ü —è —Å–º–æ–≥ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∏ –Ω–∞—à–µ–ª –æ—Ç–∫—Ä—ã—Ç—ã–π issue HAProxy Reload - Old Processes not finishing.\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç (–º–∞—Ä—Ç 24) –±–∞–≥ –Ω–µ –≤—ã–ª–µ—á–µ–Ω, –Ω–æ –µ—Å—Ç—å –∫–æ—Å—Ç—ã–ª—å –≤ –≤–∏–¥–µ hard-stop-after –¥–∏—Ä–µ–∫—Ç–∏–≤—ã, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–π –ø—Ä–æ—Ü–µ—Å—Å —Å—Ç–∞—Ä–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞. –≠–¥–∞–∫–∏–π –∞–Ω–∞–ª–æ–≥ graceful shutdown –≤ kubernetes.\n–í–æ—Ç –∫–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è 14.03:\n–í—ã–≤–æ–¥—ã –ü—Ä–∏ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —è –º–Ω–æ–≥–æ —Ä–∞–∑ —É—Ö–æ–¥–∏–ª –ø–æ –ª–æ–∂–Ω–æ–º—É –ø—É—Ç–∏ –∏ –ø—É—Ç–∞–ª –ø—Ä–∏—á–∏–Ω—É —Å–æ —Å–ª–µ–¥—Å—Ç–≤–∏–µ–º. –≠—Ç–æ –Ω–∞ –º–æ–π –≤–∑–≥–ª—è–¥ –Ω–µ –æ—à–∏–±–∫–∏, —Å–∫–æ—Ä–µ–µ –æ–±—ã—á–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å.\n–ö —Ç–æ–º—É –∂–µ —á–µ—Ä–µ–∑ —Ç–∞–∫–∏–µ –ø–æ–±–æ—á–Ω—ã–µ –≤–µ—Ç–≤–∏ –º—ã –∏ –æ–±—Ä–∞—Å—Ç–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–µ–π, —á—Ç–æ –≤ –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –Ω–∞—Å.\n–ò–∑ —è–≤–Ω—ã—Ö –æ—à–∏–±–æ–∫ –æ—Ç–º–µ—á—É:\n–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–∞–ª–µ—Ä—Ç–∏–Ω–≥/—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ; –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ - –ø—Ä–∏—Å—Ç—É–ø–∏–ª –∫ –ø–æ–∏—Å–∫—É –ø—Ä–æ–±–ª–µ–º –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∑–Ω–∞—è –∫–∞–∫ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –∑–∞–ø–æ–¥–æ–∑—Ä–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –≤ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤–æ—Ä–∫–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤). –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è ‚Äú–≤—ä–µ–¥–ª–∏–≤–æ—Å—Ç—å‚Äù –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—Å—Ç–≤–∏–∏ —Å–ø–µ—à–∫–∏, —É—Å—Ç–∞–ª–æ—Å—Ç–∏ - –∫–æ–≥–¥–∞ –Ω–∞–±–ª—é–¥–∞–µ—à—å –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —á–∞—Å—Ç–æ —Å—Ç–æ–∏—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –ø–æ—á–µ–º—É —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∞ –Ω–µ –∏–Ω–∞—á–µ. –ù–æ –≤–∞–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ —Ñ–æ–∫—É—Å–æ–º –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã. –¢–∞–∫–æ–π –ø–æ–ª—É—á–∏–ª—Å—è –∫–µ–π—Å, —É–¥–∞—á–∏!\n","wordCount":"1213","inLanguage":"en","datePublished":"2024-03-31T00:00:00Z","dateModified":"2024-03-31T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alebsys.github.io/posts/haproxy-mem-leak/"},"publisher":{"@type":"Organization","name":"Performance Matters","logo":{"@type":"ImageObject","url":"https://alebsys.github.io/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://alebsys.github.io/ accesskey=h title="Performance matters! (Alt + H)"><img src=https://alebsys.github.io/images/favicon.ico alt aria-label=logo height=35>Performance matters!</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://alebsys.github.io/about/ title=About><span>About</span></a></li><li><a href=https://alebsys.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://alebsys.github.io/for_hr/ title="For HR"><span>For HR</span></a></li><li><a href=https://alebsys.github.io/mentoring/ title=Mentoring><span>Mentoring</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://alebsys.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://alebsys.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Haproxy memory leak</h1><div class=post-meta><span title='2024-03-31 00:00:00 +0000 UTC'>March 31, 2024</span>&nbsp;¬∑&nbsp;6 min</div></header><div class=post-content><p>–ù–∞ –¥–Ω—è—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ <strong>haproxy</strong>, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –±–æ–ª–µ–µ –¥–æ–ª–≥–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã.</p><p>–ù–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ —Ö–æ—á—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–µ—Ç—Ä–æ.</p><p>–ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ–∏—Å–∫–æ–º –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º, –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º, –±—É–¥—å —Ç–æ runtime –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–µ—Ç—å, —Å–ª–æ–π –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —á—Ç–æ-—É–≥–æ–¥–Ω–æ –µ—â–µ.</p><p>–í —ç—Ç–æ—Ç —Ä–∞–∑ –ø–æ OOM –ø—Ä–∏–±–∏–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ <strong>haproxy</strong> - —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ. –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ.</p><h3 id=—Å–±–æ—Ä-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞>–°–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞<a hidden class=anchor aria-hidden=true href=#—Å–±–æ—Ä-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞>#</a></h3><p><strong>node_exporter</strong> –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞–Ω–æ–º–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ (RAM Used), —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∏ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–∫–∞—á–∫–∞–º–∏:</p><p><img loading=lazy src=/images/haproxy-mem-leak/1.png alt=node_exporter></p><p>–õ–æ–≥ OOM —Å–æ–±—ã—Ç–∏—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —É—Ç–µ–∫–ª–∏ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å—ã <strong>haproxy</strong> (–≤—ã–≤–æ–¥ –ø–æ—Ä–µ–∑–∞–Ω):</p><pre tabindex=0><code>$ dmesg -T | grep oom
...
Tasks state (memory values in pages):
[  pid  ]   rss    name
...
[2887591]    1124  haproxy
[2887593]   83058  haproxy
[2931744]  226614  haproxy
[3093691]   37094  haproxy
[3165698]   33991  haproxy
[3180514]   52974  haproxy
[3192011]  127215  haproxy
[3246961]  150239  haproxy
[3280907]  209137  haproxy
[3310000]  199742  haproxy
[3387199]   21094  haproxy
[3387315]   77567  haproxy
[3408004]  226766  haproxy
[3776117]  230883  haproxy
[ 170279] 142573  haproxy
[ 218073] 265815  haproxy
[ 402741] 183463  haproxy
[ 509821]  76463  haproxy
[ 515738] 194395  haproxy
[ 586958]  27402  haproxy
[ 599282] 100527  haproxy
[ 636940] 231200  haproxy
[ 912356] 170641  haproxy
[1270565]  168217  haproxy
[1664780]   54852  haproxy
[1677084]   27638  haproxy
[1751081]  228705  haproxy
...
Out of memory: Killed process 218073 (haproxy) total-vm:1347736kB, anon-rss:1058308kB, file-rss:108kB, shmem-rss:4844kB, UID:110 pgtables:2244kB oom_score_adj:
... 
</code></pre><blockquote><p>–∑–Ω–∞—á–µ–Ω–∏—è <code>rss</code> –∫–æ–ª–æ–Ω–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏, –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–≤–Ω–∞ 4096 –±–∞–π—Ç.</p></blockquote><p>–í –ª–æ–≥–∞—Ö <strong>haproxy</strong> –∏ –µ–≥–æ <strong>systemd</strong> —é–Ω–∏—Ç–∞ –Ω–µ –±—ã–ª–æ –Ω–∏—á–µ–≥–æ –Ω–µ–æ–±—ã—á–Ω–æ–≥–æ, —Ç–æ–ª—å–∫–æ —Ä–µ—Å—Ç–∞—Ä—Ç—ã –æ—Ç –∫–æ–ª–ª–µ–≥ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–æ–º.</p><p>–Ø —Å—Ç–∞–ª –ø–æ–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∞–ª–µ–µ –∏ —É–≤–∏–¥–µ–ª –∑–∞–Ω—è—Ç–Ω—É—é –ª–µ—Å–µ–Ω–∫—É –≤ –æ–±—ä–µ–º–µ –ø–∞–º—è—Ç–∏ –ø–æ–¥ TCP —Å–æ–∫–µ—Ç—ã:</p><p><img loading=lazy src=/images/haproxy-mem-leak/2.png alt=node_exporter></p><blockquote><p>—ç—Ç–æ –æ–±—â–µ—Å–∏—Å—Ç–µ–º–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –∏ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –µ–π –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å, —Ç–∞–∫ –∫–∞–∫ <strong>haproxy</strong> –∂–∏–≤–µ—Ç –≤ —Ö–æ—Å—Ç–æ–≤–æ–º network namespace.</p></blockquote><p>–õ–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –º–∞—à–∏–Ω–µ –±—ã–ª–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ established TCP-–∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ –≤ –ø—Ä–∏–µ–º–Ω—ã—Ö –±—É—Ñ–µ—Ä–∞—Ö:</p><pre tabindex=0><code>$ ss -nta state established -mO | awk &#39;{ if ( $1 &gt; 0 ) print }&#39;
Recv-Q Send-Q    Local Address:Port    Peer Address:Port Process
299846 0         10.10.24.5:59390     10.10.8.124:80    skmem:(r407424,rb425984,t0,tb425984,f2176,w0,o0,bl0,d12)
293893 0         10.10.24.5:60060     10.10.8.123:80    skmem:(r399552,rb425984,t0,tb425984,f1856,w0,o0,bl0,d10)
296359 0         10.10.24.5:49260     10.10.8.125:80    skmem:(r406144,rb425984,t0,tb425984,f3456,w0,o0,bl0,d15)
303378 0         10.10.24.5:33750     10.10.8.123:80    skmem:(r417024,rb425984,t0,tb425984,f768,w0,o0,bl0,d10)
299837 0         10.10.24.5:59202     10.10.8.125:80    skmem:(r413568,rb425984,t0,tb425984,f128,w0,o0,bl0,d12)
303536 0         10.10.24.5:37230     10.10.8.124:80    skmem:(r417536,rb425984,t0,tb425984,f256,w0,o0,bl0,d13)
303492 0         10.10.24.5:45944     10.10.8.125:80    skmem:(r415360,rb425984,t0,tb425984,f2432,w0,o0,bl0,d16)
...
</code></pre><blockquote><p><code>Recv-Q</code> - —Å–∫–æ–ª—å–∫–æ –±–∞–π—Ç –¥–∞–Ω–Ω—ã—Ö –æ–∂–∏–¥–∞–µ—Ç —á—Ç–µ–Ω–∏—è, –∞ <code>skmem_r</code> - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–æ –ø–∞–º—è—Ç–∏ –ø–æ–¥ —Å–æ–∫–µ—Ç (<code>Recv-Q</code> + <code>metadata</code>), –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ —ç—Ç–æ <a href="https://blog.cloudflare.com/optimizing-tcp-for-high-throughput-and-low-latency/#:~:text=is%20Linux%20autotuning.-,Linux%20autotuning,-Linux">—Ç—É—Ç</a>.</p></blockquote><p>–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ –ø–æ–¥–æ–±–Ω—ã–µ –∫–æ–Ω–Ω–µ–∫—Ç—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–µ, –≤ –∞–ø—Å—Ç—Ä–∏–º–∞—Ö –∏—Ö –Ω–µ –±—ã–ª–æ.</p><p>–§–ª–∞–≥<code> -i</code> –¥–∞—Å—Ç —á—É—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ (–≤—ã–≤–æ–¥ —Å–æ–∫—Ä–∞—â–µ–Ω):</p><pre tabindex=0><code>$ ss -nta state established -Oi | grep -A 1 59390
299846 0 10.10.24.5:59390 10.10.8.124:80 ...cubic...lastsnd:369593792 lastrcv:369592940 lastack:369592940
</code></pre><p>–ü–æ–ª—è <code>last*</code> –≥–æ–≤–æ—Ä—è—Ç, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ç–∞–≥–Ω–∏—Ä—É–µ—Ç –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 369592940 ms, —á—Ç–æ —Ä–∞–≤–Ω–æ –±–æ–ª–µ–µ 100 —á–∞—Å–∞–º.</p><p>–ó–Ω–∞—á–µ–Ω–∏—è <code>last*</code> –∫–∞–∂–¥–æ–≥–æ ‚Äú–∑–∞–≤–∏—Å—à–µ–≥–æ‚Äù —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–∞–ª–æ—Å—å, –Ω–æ –≤ —Ü–µ–ª–æ–º –æ–Ω–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º. –Ø –æ—Ç–º–µ—Ç–∏–ª —ç—Ç–æ, –Ω–æ –≤ —Ü–µ–ª–æ–º –ø—Ä–æ—à–µ–ª –¥–∞–ª—å—à–µ (–∞ –∑—Ä—è!).</p><p>–í —Ç–æ–∂–µ –≤—Ä–µ–º—è —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ TCP —Å–æ–∫–µ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Ä–∞—Å—Ç–∏:</p><p><img loading=lazy src=/images/haproxy-mem-leak/3.png alt=node_exporter></p><p>–ö–∞–∂–µ—Ç—Å—è —è –Ω–∞–ø–∞–ª –Ω–∞ —Å–ª–µ–¥!</p><p><strong>haproxy</strong> –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –∫–æ–Ω–Ω–µ–∫—Ç—ã –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–µ —Ö–æ—á–µ—Ç (–Ω–µ –º–æ–∂–µ—Ç?) –≤—ã—á–∏—Ç–∞—Ç—å –∏—Ö. –Ø —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª –≥–∏–ø–æ—Ç–µ–∑—É - –ø–∞–º—è—Ç—å —Ä–∞—Å—Ö–æ–¥—É–µ—Ç—Å—è –∑–∞ —Å—á–µ—Ç ‚Äú–ø–æ–≤–∏—Å—à–∏—Ö‚Äù –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤.</p><p>üí° –î–∞-–¥–∞, —Ç—É—Ç —Å–∫–æ—Ä–µ–µ –Ω–∞—Ç—è–≥–∏–≤–∞–Ω–∏–µ —Å–æ–≤—ã –Ω–∞ –≥–ª–æ–±—É—Å, —Ç–∞–∫ –∫–∞–∫ –ø–æ–¥ –∫–æ–Ω–Ω–µ–∫—Ç—ã –≤ –ø–∏–∫–µ –±—ã–ª–æ –≤—ã–¥–µ–ª–µ–Ω–æ ~240MB, —á—Ç–æ –∫–æ–Ω–µ—á–Ω–æ –Ω–µ —É–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –æ–±—â–∏–º–∏ –ø–æ—Ç–µ—Ä—è–º–∏. –ù–æ —á—Ç–æ –µ—Å–ª–∏ haproxy –ø–æ–¥ —ç—Ç–∏ –∫–æ–Ω–Ω–µ–∫—Ç—ã —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ –ø–∞–º—è—Ç–∏?</p><p>–í –æ–±—â–µ–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –æ—á–µ–≤–∏–¥–Ω–∞ –∏ —è –Ω–∞—á–∞–ª —Ä–∞—Å–∫—Ä—É—á–∏–≤–∞—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é.</p><h3 id=–ø—Ä–æ–≤–µ—Ä–∫–∞-–≥–∏–ø–æ—Ç–µ–∑>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑<a hidden class=anchor aria-hidden=true href=#–ø—Ä–æ–≤–µ—Ä–∫–∞-–≥–∏–ø–æ—Ç–µ–∑>#</a></h3><p>TCP keepalive –º–µ—Ö–∞–Ω–∏–∑–º—ã –º–æ–≥–ª–∏ –±—ã –ø–æ–º–æ—á—å –≤ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤, –Ω–æ –æ–Ω–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±—É—Ñ–µ—Ä–∞—Ö (–ø—Ä–æ–≤–µ—Ä—è–ª –ø–æ–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–Ω—è—Ç–∏–µ –¥–∞–º–ø–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –¥–≤–∏–∂–µ–Ω–∏–π –ø–∞–∫–µ—Ç–æ–≤ –≤ —Å–æ–∫–µ—Ç–µ –∑–∞–º–µ—á–µ–Ω–æ –Ω–µ –±—ã–ª–æ).</p><p>–ù–æ –ø–æ—á–µ–º—É —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∫—Ç–æ –Ω–µ —á–∏—Ç–∞–µ—Ç? –ü—Ä–æ—Ü–µ—Å—Å—ã (–≤–ª–∞–¥–µ–ª—å—Ü—ã —Å–æ–∫–µ—Ç–æ–≤) –≤—ã–≥–ª—è–¥—è—Ç –≤–ø–æ–ª–Ω–µ –∂–∏–≤—ã–º–∏.</p><p>–ü–æ—Å–ª–µ –±–µ–≥–ª–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —è –Ω–µ —Å–º–æ–≥ –¥–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏—á–Ω–µ–µ —á–µ–º ‚Äú–ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–∏—Å–ª–∏ –∏/–∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã‚Äù.</p><p>–ò–∑ –±—ã—Å—Ç—Ä—ã—Ö work-around‚Äô–æ–≤ –≤ –≥–æ–ª–æ–≤—É –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ –ª–∏–±–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç <strong>haproxy</strong> –ª–∏–±–æ –æ—Ç—Å—Ç—Ä–µ–ª–∏–≤–∞–Ω–∏–µ –ø–æ–≤–∏—Å—à–∏—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤.</p><p>–ò —Ç—É—Ç –Ω–∞ –≥–ª–∞–∑–∞ –º–Ω–µ –ø–æ–ø–∞–ª—Å—è –≥—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ UDP –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ (<code>UDP_inuse</code>):</p><p><img loading=lazy src=/images/haproxy-mem-leak/4.png alt=node_exporter></p><p>–ö–∞–∂–¥—ã–π —Å–∫–∞—á–µ–∫ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Ö–æ—Ä–æ—à–æ –±—ã–ª –≤–∏–¥–µ–Ω –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –æ—Ç–ª–∏—á–∏–∏ –æ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è TCP.</p><p>–Ø —Å–æ–ø–æ—Å—Ç–∞–≤–∏–ª —ç—Ç–∏ —Ç–∞–π–º–∏–Ω–≥–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ <strong>atop</strong> - –≤ –º–æ–º–µ–Ω—Ç —Ä–æ—Å—Ç–∞ UDP –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–ª—Å—è –µ—â–µ –æ–¥–Ω–∏ –ø—Ä–æ—Ü–µ—Å—Å <strong>haproxy</strong>, —Ç–æ–≥–¥–∞ –∫–∞–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å.</p><p>–ò –µ—â–µ —Ä–∞–∑ –ø—Ä–∏—Å–º–æ—Ç—Ä–µ–ª—Å—è –∫ <strong>systemd</strong> –ª–æ–≥–∞–º:</p><pre tabindex=0><code>$ journalctl -u haproxy
...
Jan 23 08:58:25 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 23 08:58:25 haproxy[2887591]: [NOTICE]   (2887591) : New worker (2931744) forked
Jan 25 04:42:44 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 25 04:42:44 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3093691) forked
Jan 25 06:40:45 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 25 06:40:45 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3144234) forked
Jan 25 07:06:58 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 25 07:06:58 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3157985) forked
Jan 25 07:10:56 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 25 07:10:56 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3159942) forked
Jan 25 07:42:50 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 25 07:42:50 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3165698) forked
Jan 26 11:11:56 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 26 11:11:56 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3387315) forked
Jan 26 11:41:37 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 26 11:41:37 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3408004) forked
Jan 30 08:45:37 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Jan 30 08:45:37 haproxy[2887591]: [NOTICE]   (2887591) : New worker (3776117) forked
Feb  5 03:58:20 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Feb  5 03:58:20 haproxy[2887591]: [NOTICE]   (2887591) : New worker (148797) forked
Feb  5 03:59:15 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Feb  5 03:59:15 haproxy[2887591]: [NOTICE]   (2887591) : New worker (149187) forked
Feb  5 04:29:50 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Feb  5 04:29:50 haproxy[2887591]: [NOTICE]   (2887591) : New worker (164172) forked
Feb  5 04:47:53 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Feb  5 04:47:53 haproxy[2887591]: [NOTICE]   (2887591) : New worker (170279) forked
Feb  5 14:17:46 haproxy[2887591]: Reloaded HAPEE Load Balancer.
Feb  5 14:17:46 haproxy[2887591]: [NOTICE]   (2887591) : New worker (218073) forked
... 
</code></pre><p>–ü–∞–∑–ª —Å—Ç–∞–ª —Å–æ–±–∏—Ä–∞—Ç—å—Å—è.</p><p>–†–µ—Å—Ç–∞—Ä—Ç <strong>haproxy</strong> –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –ø–æ—Ä–æ–∂–¥–µ–Ω–∏—é –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –∞–∫—Ç–∏–≤–Ω–æ –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞–ª –ø–∞–º—è—Ç—å –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã (–Ω–∞–ø–æ–º–Ω—é —á—Ç–æ —Å—Ç–∞—Ä—ã–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å). –°–ª–µ–¥—É—é—â–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç –¥–æ–±–∞–≤–ª—è–ª –µ—â–µ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å –∏ —Ç–∞–∫ –ø–æ –∫—Ä—É–≥—É, –ø–æ–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä–µ–º –ø–∞–º—è—Ç–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª OOM Killer.</p><p>–Ø –Ω–∞–∫–æ–Ω–µ—Ü –¥–æ–±—Ä–∞–ª—Å—è –¥–æ –∫–æ–Ω—Ñ–∏–≥–∞ <strong>haproxy</strong>, —á—Ç–æ –¥–∞–ª–æ –º–Ω–µ –µ—â–µ –æ–¥–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–ª–∏—á–∏—è —É—Ç–µ—á–∫–∏ - –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –¥–∏—Ä–µ–∫—Ç–∏–≤–æ–π <a href=https://www.haproxy.com/documentation/haproxy-configuration-manual/latest/#nbthread><code>nbthread 6</code></a>, —Ç–æ –µ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ç—Ä–µ–¥—ã –æ–¥–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞. –ê —É –Ω–∞—Å –≤–æ—Ä–∫–µ—Ä–æ–≤ –±—ã–ª–∏ –¥–µ—Å—è—Ç–∫–∏.</p><p>–ù–∞–∫–æ–Ω–µ—Ü —è —Å–º–æ–≥ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∏ –Ω–∞—à–µ–ª –æ—Ç–∫—Ä—ã—Ç—ã–π issue <a href=https://github.com/haproxy/haproxy/issues/1876>HAProxy Reload - Old Processes not finishing</a>.</p><p>–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç (–º–∞—Ä—Ç 24) –±–∞–≥ –Ω–µ –≤—ã–ª–µ—á–µ–Ω, –Ω–æ –µ—Å—Ç—å –∫–æ—Å—Ç—ã–ª—å –≤ –≤–∏–¥–µ <a href=https://www.haproxy.com/documentation/haproxy-configuration-manual/latest/#hard-stop-after><code>hard-stop-after</code></a> –¥–∏—Ä–µ–∫—Ç–∏–≤—ã, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–π –ø—Ä–æ—Ü–µ—Å—Å —Å—Ç–∞—Ä–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞. –≠–¥–∞–∫–∏–π –∞–Ω–∞–ª–æ–≥ graceful shutdown –≤ <strong>kubernetes</strong>.</p><p>–í–æ—Ç –∫–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è 14.03:</p><p><img loading=lazy src=/images/haproxy-mem-leak/5.png alt=node_exporter></p><h3 id=–≤—ã–≤–æ–¥—ã>–í—ã–≤–æ–¥—ã<a hidden class=anchor aria-hidden=true href=#–≤—ã–≤–æ–¥—ã>#</a></h3><p>–ü—Ä–∏ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —è –º–Ω–æ–≥–æ —Ä–∞–∑ —É—Ö–æ–¥–∏–ª –ø–æ –ª–æ–∂–Ω–æ–º—É –ø—É—Ç–∏ –∏ –ø—É—Ç–∞–ª –ø—Ä–∏—á–∏–Ω—É —Å–æ —Å–ª–µ–¥—Å—Ç–≤–∏–µ–º. –≠—Ç–æ –Ω–∞ –º–æ–π –≤–∑–≥–ª—è–¥ –Ω–µ –æ—à–∏–±–∫–∏, —Å–∫–æ—Ä–µ–µ –æ–±—ã—á–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å.</p><p>–ö —Ç–æ–º—É –∂–µ —á–µ—Ä–µ–∑ —Ç–∞–∫–∏–µ –ø–æ–±–æ—á–Ω—ã–µ –≤–µ—Ç–≤–∏ –º—ã –∏ –æ–±—Ä–∞—Å—Ç–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–µ–π, —á—Ç–æ –≤ –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –Ω–∞—Å.</p><p>–ò–∑ —è–≤–Ω—ã—Ö –æ—à–∏–±–æ–∫ –æ—Ç–º–µ—á—É:</p><ul><li>–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–∞–ª–µ—Ä—Ç–∏–Ω–≥/—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ;</li><li>–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ - –ø—Ä–∏—Å—Ç—É–ø–∏–ª –∫ –ø–æ–∏—Å–∫—É –ø—Ä–æ–±–ª–µ–º –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∑–Ω–∞—è –∫–∞–∫ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –∑–∞–ø–æ–¥–æ–∑—Ä–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –≤ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤–æ—Ä–∫–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤).</li><li>–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è &ldquo;–≤—ä–µ–¥–ª–∏–≤–æ—Å—Ç—å&rdquo; –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—Å—Ç–≤–∏–∏ —Å–ø–µ—à–∫–∏, —É—Å—Ç–∞–ª–æ—Å—Ç–∏ - –∫–æ–≥–¥–∞ –Ω–∞–±–ª—é–¥–∞–µ—à—å –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —á–∞—Å—Ç–æ —Å—Ç–æ–∏—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –ø–æ—á–µ–º—É —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∞ –Ω–µ –∏–Ω–∞—á–µ. –ù–æ –≤–∞–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ —Ñ–æ–∫—É—Å–æ–º –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã.</li></ul><p>–¢–∞–∫–æ–π –ø–æ–ª—É—á–∏–ª—Å—è –∫–µ–π—Å, —É–¥–∞—á–∏!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://alebsys.github.io/tags/linux/>Linux</a></li><li><a href=https://alebsys.github.io/tags/haproxy/>Haproxy</a></li><li><a href=https://alebsys.github.io/tags/memory/>Memory</a></li><li><a href=https://alebsys.github.io/tags/network/>Network</a></li><li><a href=https://alebsys.github.io/tags/troubleshooting/>Troubleshooting</a></li></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-alebsys-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://alebsys.github.io/>Performance Matters</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>